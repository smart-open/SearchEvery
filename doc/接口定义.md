# 接口定义（Tauri Commands / IPC）

说明：以下为桌面端 Tauri 后端（Rust）暴露给前端的命令与数据模型约定，用于扫描、解析、索引、搜索、去重与配置管理。

## 1. 数据模型
- FileMeta：
  - id: string（UUID）
  - path: string
  - type: enum(text|document|image|audio|video|binary)
  - size: number
  - mtime: number（Unix 毫秒）
  - hash: string|null
  - status: enum(new|indexed|failed)
  - vector_status: enum(none|pending|done|failed)

- IndexDoc：
  - file_id: string
  - file_name: string
  - content: string|null
  - title_lvl1/2/3: string|null
  - tags: string[]

- SearchFilters：
  - type?: string[]
  - size_range_mb?: [number, number]
  - time_range?: [number, number]
  - path_prefix?: string

- SearchResult：
  - file_id: string
  - file_name: string
  - path: string
  - type: string
  - snippet?: string
  - score: number（融合后分数）
  - bm25?: number
  - vector_sim?: number
  - hit_fields?: string[]（命中字段名称）

## 2. 命令定义（后端）
- scan_start(params):
  - params: { include_paths: string[]; exclude_paths?: string[]; max_file_size_mb?: number; concurrency?: number }
  - 返回：{ started: true, task_id: string }

- scan_pause(task_id)
- scan_resume(task_id)
- scan_status(task_id)
  - 返回：{ progress: number, scanned: number, indexed: number, failed: number, queue_sizes: { parse: number, embed: number } }

- index_rebuild(options)
  - options: { full?: boolean; reembed?: boolean }
  - 返回：{ accepted: true }

- search(query, mode, filters, top_k?)
  - query: string
  - mode: "hybrid" | "inverted" | "vector"
  - filters: SearchFilters
  - top_k: number（默认 50）
  - 返回：SearchResult[]

- dedup_scan_start(options)
  - options: { precise_hash?: boolean; image_phash?: boolean; audio_fp?: boolean; video_frame_phash?: boolean; text_simhash?: boolean }
  - 返回：{ started: true, task_id: string }

- dedup_results(task_id)
  - 返回：Array<{ group_id: string, members: Array<{ file_id, path, size }>, kind: string (exact|image|audio|video|text) }>

- dedup_delete(task_id, group_id, keep_rule)
  - keep_rule: { strategy: "latest"|"largest"|"path_pref"; path_prefix?: string }
  - 返回：{ deleted: number, moved_to_trash: boolean }

- config_get()
  - 返回：完整 config.json 对象

- config_set(partial)
  - partial: Partial<config>
  - 返回：{ saved: true }

- test_connection(target)
  - target: { type: "cloud_ai"|"vector_db"; vendor?: string }
  - 返回：{ ok: boolean, message?: string }

## 3. 事件（前端订阅）
- scanner.progress：{ task_id, progress, scanned, indexed }
- indexer.progress：{ stage: "parse"|"embed"|"commit", queue_sizes }
- dedup.progress：{ task_id, found_groups }

## 4. 错误与重试约定
- 所有命令返回 { ok: false, error_code, message } 时，前端应提供重试入口，并显示日志 ID。
- 后端对解析/嵌入失败项自动进入重试队列（最多 3 次）。