# 技术实现方案（SearchEverywhere 桌面端）

## 1. 概述
SearchEverywhere 是一款跨平台桌面应用（Windows/macOS/Linux），用于全盘文件检索与管理。系统通过倒排索引 + 向量检索混合搜索实现高性能、高召回的检索体验，并提供重复文件识别与清理功能。支持中文分词（jieba），可选接入本地/云端大模型用于图片/音频/视频的识别增强，及 Milvus/ChromaDB/LanceDB 等向量数据库。

## 2. 总体架构
- 前端桌面框架：推荐 Tauri（Rust + Web 前端），兼顾性能、体积与跨平台；可选替代：Electron（Node.js + Chromium）。
  - 采纳方案：本项目以 Tauri 为首选实现与交付目标。
- 核心服务（本地）：
  - 文件扫描器（Scanner，Rust）：遍历所有分区与挂载点，排除系统目录，生成文件元数据。
  - 内容解析器（Extractor）：按文件类型提取文本或元信息；复杂解析与 AI 处理可由“侧车”进程完成（Python/本地推理）。
  - 倒排索引（Inverted Index，Rust）：基于 tantivy + jieba（cjieba）构建中文索引，支持字段权重与 BM25。
  - 向量索引（Vector Index）：可选集成 Milvus/ChromaDB/LanceDB；嵌入模型可选本地（Ollama/开源嵌入）或云端厂商。
  - 混合检索（Hybrid Search）：综合倒排分数与向量相似度，支持用户指定检索模式。
  - 去重扫描（Deduplicator）：哈希与指纹（pHash/Chromaprint/视频帧采样）识别重复与近似重复。
- 大模型与嵌入：
  - 现阶段：暂不接入大模型（云端/Ollama）。仅保留非大模型处理：OCR（Tesseract）与 ASR（Whisper.cpp）。
  - 后续阶段：可选接入 Ollama 与外部厂商（豆包/阿里/腾讯），并为嵌入与图像描述提供能力。
- 存储：
  - 索引：tantivy（倒排），SQLite/RocksDB 存储元数据与配置。
  - 向量：Milvus/Chroma/LanceDB 根据用户配置（默认使用 ChromaDB 本地部署）。

## 3. 模块设计与职责
1) 文件扫描器
- 递归遍历磁盘：
  - Windows：所有盘符（A-Z），排除 C:\\Windows、Program Files、ProgramData、Users\\{user}\\AppData 等。
  - macOS：/Volumes/*，排除 /System、/Library、~/Library。
  - Linux：/、/mnt、/media，排除 /proc、/sys、/dev、/run、/var/log 等。
- 记录：路径、类型、大小、哈希（可延迟计算）、扩展名、创建/修改时间。
- 增量更新：文件系统监听（Windows USN Journal/ReadDirectoryChangesW，mac FSEvents，Linux inotify）或定期扫描。

2) 内容解析器（Extractor）
- 文本类：txt、md、json、xml、csv、代码文件等，直接读取 UTF-8/GBK 自动探测与转码（chardet）。
- 可提取文件：
  - PDF：PyMuPDF（fitz）或 pdfminer.six；
  - Office：docx（python-docx/mammoth）、xlsx（openpyxl）、pptx（python-pptx）；
  - OFD：暂不在首版实现；后期考虑支持。当前阶段如需解析，可选“转换为 PDF 再解析”的回退方案。
- 图片/语音/视频：
  - 默认仅索引文件名；
  - 若开启大模型/识别增强：
    - 图片：OCR（Tesseract，建议安装中文语言数据包）+ 可选图像描述（BLIP/LLaVA via Ollama）。
    - 语音：ASR（Whisper.cpp 本地或外部厂商语音识别 API）。
    - 小视频：抽取音频（FFmpeg）→ ASR；可选关键帧 OCR/图像描述。

3) 倒排索引（Inverted Index）
- 引擎：tantivy（Rust）+ cjieba 分词。
- 字段：file_name、content、title_level（1/2/3）、tags、path、type、mtime、size。
- 权重（Boost）：
  - 默认权重 10；
  - 文件名称 80；
  - 内容标题：一级 60、二级 40、三级 20。
- 评分：BM25 + 字段 Boost；支持停用词与同义词词典（可选）。

4) 向量索引（Vector Index）
- 文本嵌入：bge-m3（中文表现优）、text-embedding-3-large（云端可选）、ernie-embedding（百度，若需要）。
- 图片嵌入：OpenAI CLIP/ViT-L/14、EVA-CLIP；
- 音频/视频：以转写文本为主进行嵌入；可选 audio embedding（检索旋律/环境音）。
- 数据库：
  - Milvus：IVF_FLAT/HNSW，cosine/L2；
  - ChromaDB：本地轻量（默认选型，用于首版交付）；
  - LanceDB：列式存储，HNSW 支持。
- 同步策略：
  - 索引生成队列：文件解析→文本/特征→嵌入→入库；
  - 失败重试与断点续传；
  - 向量维度与模型一致性校验。

-5) 混合检索（Hybrid Search）
- 模式：默认“仅倒排”；用户可选择开启“倒排 + 向量”混合或“仅向量”（需先配置嵌入与向量库）。
- 合并策略：score = α·BM25(field_boost) + β·cosine_similarity；α、β可配置（默认 α=0.7, β=0.3）。
- 命中解释：展示字段命中、分词片段、相似度，支持高亮。

6) 去重扫描（Deduplicator）
- 精确重复：SHA-256/xxHash 基于文件内容；
- 图片近重：pHash/aHash + 感知相似阈值；
- 音频近重：Chromaprint/AcoustID 指纹；
- 视频近重：关键帧抽取（FFmpeg），帧 pHash 聚类；
- 文本近重：SimHash；
- 结果归并：同组列表 + 体积占用 + 建议删除项；提供“仅展示安全可删副本”的守护逻辑（跳过系统/程序目录）。

7) 配置中心
 - 大模型：默认关闭；当前版本不接入。后期可按需开启（厂商/地址/API Key/模型/温度）。
 - 向量数据库：类型（Milvus/Chroma/LanceDB）、地址、鉴权、集合名、维度、度量、索引参数（HNSW/IVF 等）。默认使用 ChromaDB（本地），但首版向量检索为可选关闭。
 - 扫描与排除：目录白/黑名单；文件类型开关；最大文件大小；CPU/GPU 使用策略。
 - 默认配置建议：
   - 模式：仅倒排；开启混合后可采用线性融合（建议 α=0.7，β=0.3）。
   - OCR：默认 Tesseract；ASR：默认 Whisper.cpp。

## 4. 关键技术与难点解决方案
1) 中文分词与索引
- 采用 cjieba + tantivy 自定义分词器；支持用户词典与停用词；标题字段启用更高 Boost。
- 性能优化：批量写入、分片索引、并发管线；大文件流式读取避免内存峰值。

2) 文件解析的兼容性
- Office/OFD 多方案并存：优先无损库；失败回退到转换（LibreOffice headless）。
- 字符编码与二进制混杂：自动探测，失败则二进制仅索引文件名。

3) AI 识别的成本与加速
- 本地优先：Whisper.cpp、Tesseract；可按需启用 GPU（CUDA/Metal）。
- 任务调度：限流队列 + 优先级（前台检索优先于后台构建）。
- 缓存：识别结果与嵌入缓存，避免重复计算。

4) 向量数据库的选择与同步
- 小规模：ChromaDB 本地；中大型：Milvus；结构化存储与索引参数可配置。
- 一致性：元数据记录向量状态，失败重试，定期校验维度与度量。

5) 跨平台打包与权限
- Tauri Bundler：Windows MSI/NSIS，macOS dmg，Linux deb/rpm；
- 权限：首次运行请求“访问文件系统”，说明用途；mac 需要签名与沙箱声明；Windows UAC 提示。

6) 重复文件删除的安全性
- 多重确认与回收站（Windows：Recycle Bin；mac：Trash；Linux：移动到 ~/.local/share/Trash）。
- 默认不显示系统目录与可执行文件的删除建议。

## 5. 数据模型与存储
- SQLite（配置/元数据）：files(id, path, type, size, mtime, hash, status, vector_status, created_at, updated_at)
- Tantivy Schema：file_name(text, boost=80), content(text, boost=10), title_lvl1(text, boost=60), title_lvl2(text, boost=40), title_lvl3(text, boost=20), tags(text), path(keyword), type(keyword), mtime(i64), size(i64)
- 向量库：collection：id、file_id、modality(text/image/audio/video/binary)、embedding(vector<float>)、dim、model、created_at

## 6. 检索与排序算法
- 倒排：BM25（k1,b 可调）+ 字段 Boost；高亮使用命中位置切片。
- 向量：cosine/L2 相似度，Top-K；可启用重排序（RRF/融合函数）。
- 混合：线性融合（默认）；可选学习融合（训练小模型权重，后期可升级）。

## 7. 性能与资源控制
- 并发：Rayon（Rust）/Tokio 异步；侧车 Python 使用 multiprocessing + 队列。
- I/O：分区并行 + 速率限制；大文件分块读取；
- 资源：CPU/GPU 使用上限；后台低优先级；前台交互优先。

## 8. 安全、隐私与合规
- 本地优先原则：数据不出端；云端调用需显式开启与密钥配置。
- 敏感目录默认排除；日志不记录内容，仅记录统计与错误。
- 开源依赖许可证评估，第三方模型合规说明。

## 9. 开发计划（里程碑）
- M1 原型（2-3 周）：扫描/倒排/检索基本功能；Windows 首发。
- M2 解析增强（2 周）：PDF/Office 基本支持（OFD 暂缓）；配置页；去重扫描。
- M3 向量索引（2 周）：嵌入与 ChromaDB 接入（默认）；混合检索。
- M4 AI 增强（2-3 周）：OCR（Tesseract）/ASR（Whisper.cpp）/图像描述；Ollama/云厂商（豆包/阿里/腾讯）接入与默认配置模板。
- M5 跨平台打包与优化（2 周）：mac/Linux；性能与稳定性。

## 10. 技术栈清单
- 桌面：Tauri（Rust 1.75+），前端 React/Vue + TypeScript（二选一）。
- 索引：tantivy、cjieba。
- 解析：PyMuPDF、pdfminer.six、python-docx、openpyxl、python-pptx、chardet、ffmpeg。
- OCR/ASR：Tesseract（中文语言包）、whisper.cpp、FFmpeg。
- 向量：Milvus/ChromaDB/LanceDB（默认 ChromaDB）；嵌入模型：bge-m3、CLIP、Ollama 系列。
- 存储：SQLite/RocksDB。

## 11. 风险与备选方案
- OFD 解析暂缓：如需支持，提供转换为 PDF 的回退；或引入商业 SDK。
- OCR 质量：Tesseract 在复杂版式/低质量图片上效果有限，后期可评估引入更强 OCR（如 PaddleOCR 或商业方案）。
- 大模型成本与速度：默认关闭；本地模型优先；提供并发与速率限制。
- 中文分词歧义：用户词典与同义词；特殊领域词汇自定义。
- 跨平台差异：文件系统事件兼容层，统一抽象。

## 12. 示例处理流程（伪代码）
```text
for file in scan_all_paths(excludes):
  meta = stat(file)
  enqueue(parse_queue, meta)

worker parse_queue:
  text = extract_text(meta)
  tokens = jieba_cut(text)
  inverted_index.add(meta.file_name, tokens_with_boost)
  if vector_enabled and modality in [text,image,audio,video,binary]:
    emb = embed(modality, text_or_features)
    vector_db.upsert(meta.id, emb)

search(query, mode=hybrid):
  tokens = jieba_cut(query)
  bm25_results = inverted_index.search(tokens)
  if mode != inverted_only:
    emb = embed(text, query)
    vec_results = vector_db.search(emb)
  return merge(bm25_results, vec_results)
```